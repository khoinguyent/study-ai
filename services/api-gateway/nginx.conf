events {
    worker_connections 1024;
}

http {
    # Increase client body size for file uploads
    client_max_body_size 100M;
    
    upstream auth_service {
        server auth-service:8001;
    }

    upstream document_service {
        server document-service:8002;
    }

    upstream indexing_service {
        server indexing-service:8003;
    }

    upstream quiz_service {
        server quiz-service:8004;
    }

    upstream notification_service {
        server notification-service:8005;
    }

    # Rate limiting
    limit_req_zone $binary_remote_addr zone=api:10m rate=10r/s;

    server {
        listen 80;
        server_name localhost;

        # Disable automatic trailing slash redirects
        disable_symlinks off;

        # Health check endpoint
        location /health {
            access_log off;
            add_header Content-Type text/plain;
            return 200 "healthy\n";
        }

        # Auth service routes
        location /auth/ {
            limit_req zone=api burst=20 nodelay;
            proxy_pass http://auth_service/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Document service routes (handle all document requests)
        location /documents {
            limit_req zone=api burst=20 nodelay;
            proxy_pass http://document_service/documents$is_args$args;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # Increase timeout for file uploads
            proxy_connect_timeout 300s;
            proxy_send_timeout 300s;
            proxy_read_timeout 300s;
        }

        # Document service sub-paths (like upload-multiple)
        location /documents/ {
            limit_req zone=api burst=20 nodelay;
            proxy_pass http://document_service/documents/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # Increase timeout for file uploads
            proxy_connect_timeout 300s;
            proxy_send_timeout 300s;
            proxy_read_timeout 300s;
        }



        # Subjects/Categories routes (handled by document service)
        location /subjects {
            limit_req zone=api burst=20 nodelay;
            proxy_pass http://document_service/subjects;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Categories routes (handled by document service)
        location /categories {
            limit_req zone=api burst=20 nodelay;
            proxy_pass http://document_service/categories;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Indexing service routes (internal only)
        location /indexing/ {
            limit_req zone=api burst=20 nodelay;
            proxy_pass http://indexing_service/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Quiz service routes
        location /quiz/ {
            limit_req zone=api burst=20 nodelay;
            proxy_pass http://quiz_service/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Notification service routes
        location ~ ^/notifications/([^/]+)$ {
            limit_req zone=api burst=20 nodelay;
            proxy_pass http://notification_service/notifications/$1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Notification service routes (for POST requests)
        location /notifications {
            limit_req zone=api burst=20 nodelay;
            proxy_pass http://notification_service/notifications;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Notification health endpoint
        location /notifications/health {
            limit_req zone=api burst=20 nodelay;
            proxy_pass http://notification_service/health;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Task status routes
        location /task-status {
            limit_req zone=api burst=20 nodelay;
            proxy_pass http://notification_service/task-status;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # User tasks routes
        location ~ ^/users/([^/]+)/tasks$ {
            limit_req zone=api burst=20 nodelay;
            proxy_pass http://notification_service/users/$1/tasks;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # WebSocket connection for notifications
        location ~ ^/ws/([^/]+)$ {
            proxy_pass http://notification_service/ws/$1;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_read_timeout 86400; # 24 hours
        }

        # Dead Letter Queue Management API
        location /dlq/ {
            limit_req zone=api burst=20 nodelay;
            proxy_pass http://dlq-api:8006/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Upload endpoints - proxy to FastAPI app
        location /upload {
            limit_req zone=api burst=20 nodelay;
            proxy_pass http://127.0.0.1:8000/upload;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # Increase timeout for file uploads
            proxy_connect_timeout 300s;
            proxy_send_timeout 300s;
            proxy_read_timeout 300s;
        }

        # Upload multiple endpoints - proxy to FastAPI app
        location /upload-multiple {
            limit_req zone=api burst=20 nodelay;
            proxy_pass http://127.0.0.1:8000/upload-multiple;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # Increase timeout for file uploads
            proxy_connect_timeout 300s;
            proxy_send_timeout 300s;
            proxy_read_timeout 300s;
        }

        # Handle preflight requests for unmatched routes (must be last)
        location / {
            if ($request_method = 'OPTIONS') {
                add_header 'Access-Control-Allow-Origin' '*';
                add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, OPTIONS';
                add_header 'Access-Control-Allow-Headers' 'DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range,Authorization';
                add_header 'Access-Control-Max-Age' 1728000;
                add_header 'Content-Type' 'text/plain; charset=utf-8';
                add_header 'Content-Length' 0;
                add_header 'Cache-Control' 'no-cache, no-store, must-revalidate';
                add_header 'Pragma' 'no-cache';
                add_header 'Expires' '0';
                return 204;
            }
            return 404 "Not Found\n";
        }
    }
} 